name: Release on Version Tag

on:
  push:
    tags:
      - 'v[0-9]+\.[0-9]+\.[0-9]+'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract version from tag
        id: get_version
        run: |
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Update CMakeLists.txt VERSION
        run: |
          sed -i '/^project(/,/^)/{s/VERSION [0-9]\+\.[0-9]\+\.[0-9]\+/VERSION '"${{ steps.get_version.outputs.version }}"'/}' "CMakeLists.txt"
      - name: Commit version change
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "CMakeLists.txt"
          git commit -m "chore: update version to ${{ steps.get_version.outputs.version }}"
      - name: Create tag
        run: |
          git tag -a "${{ steps.get_version.outputs.version }}" -m "Release ${{ steps.get_version.outputs.version }}"
          git push origin "${{ steps.get_version.outputs.version }}"
      - name: Push version commit to main branch
        run: |
          git push origin HEAD:main
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "${{ steps.get_version.outputs.version }}" > /dev/null 2>&1; then
            echo "Release already exists: ${{ steps.get_version.outputs.version }}"
            exit 0
          fi

          gh release create "${{ steps.get_version.outputs.version }}" \
            --title "Release ${{ steps.get_version.outputs.version }}" \
            --generate-notes \
            --prerelease=false \
            --draft=false
          for RETRY in $(seq 1 10); do
            if gh release view "${{ steps.get_version.outputs.version }}" > /dev/null 2>&1; then
              break
            fi
            echo "Waiting for release to be available... (${RETRY}/10)"
            sleep 2
          done
